{% extends "base.html" %}

{% block title %}Our Parents - Tucson Golden Doodles{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    {% if parents %}
        {% for parent in parents %}
        <div class="parent-name-banner" id="parent-{{ parent.id }}">
            <h1 class="display-5 text-white text-uppercase text-center py-3">{{ parent.name }}</h1>
        </div>

        <div class="container my-5">
            <div class="row g-4 parent-layout-container">
                <div class="col-md-6 parent-image-column">
                    {# Image Carousel for S3 keys #}
                    {% set all_carousel_keys = [] %}
                    {% if parent.main_image_s3_key %}{% set _ = all_carousel_keys.append(parent.main_image_s3_key) %}{% endif %}
                    {% if parent.alternate_image_s3_key_1 %}{% set _ = all_carousel_keys.append(parent.alternate_image_s3_key_1) %}{% endif %}
                    {% if parent.alternate_image_s3_key_2 %}{% set _ = all_carousel_keys.append(parent.alternate_image_s3_key_2) %}{% endif %}
                    {% if parent.alternate_image_s3_key_3 %}{% set _ = all_carousel_keys.append(parent.alternate_image_s3_key_3) %}{% endif %}
                    {% if parent.alternate_image_s3_key_4 %}{% set _ = all_carousel_keys.append(parent.alternate_image_s3_key_4) %}{% endif %}

                    {% if all_carousel_keys %}
                    <div id="parentCarousel-{{ parent.id }}" class="carousel slide parent-carousel-wrapper">
                        <div class="carousel-inner">
                            {% for s3_key in all_carousel_keys %}
                            <div class="carousel-item {{ 'active' if loop.first }}">
                                {# --- THIS IS THE FIX --- #}
                                {# Add a fallback to a placeholder image if the s3_url is None #}
                                <img src="{{ s3_key | s3_url or url_for('static', filename='img/placeholder.jpg') }}" class="d-block w-100 carousel-image" alt="Parent image {{ loop.index }}">
                            </div>
                            {% endfor %}
                        </div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#parentCarousel-{{ parent.id }}" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#parentCarousel-{{ parent.id }}" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        </button>
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-6 parent-info-column">
                    <div class="text-center mt-md-0 mt-4">
                        <h3 class="breed-header">{{ parent.breed }}</h3>
                        <p class="weight-header">
                            {% if parent.weight_kg is not none %}
                                {{ parent.weight_kg }} kg / {{ (parent.weight_kg * 2.20462)|round(1) }} lbs
                            {% else %}
                                Weight: N/A
                            {% endif %}
                        </p>
                    </div>
                    <div class="description-paragraphs mt-4">
                        {% if parent.description %}
                            {% for paragraph in parent.description.split('\n') %}
                                {% if paragraph.strip() %}
                                    <p>{{ paragraph.strip() }}</p>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>

            {% if parent.grouped_litters %}
            <div class="past-puppies-header mt-5 text-center">
                <h2>{{ parent.name | upper }}'S PAST PUPPIES</h2>
            </div>
            {% for (birth_date, dad, mom), puppies in parent.grouped_litters.items() %}
                <div class="litter-banner">
                    <a href="{{ url_for('puppies.list_puppies') }}#litter-{{ birth_date.strftime('%Y%m%d') }}-{{ dad.id }}-{{ mom.id }}">
                        Litter with {{ mom.name if parent.role.name == 'DAD' else dad.name }} (Born: {{ birth_date.strftime('%B %Y') }})
                    </a>
                </div>
                <div class="past-puppies-thumbnails-row">
                    <div class="d-flex flex-nowrap overflow-auto py-2">
                        {% for puppy in puppies %}
                        <div class="p-2 flex-shrink-0 puppy-thumbnail-wrapper">
                            <a href="{{ url_for('puppies.list_puppies') }}#litter-{{ birth_date.strftime('%Y%m%d') }}-{{ dad.id }}-{{ mom.id }}" title="{{ puppy.name }} ({{ puppy.status.value }})">
                                {# --- THIS IS THE FIX --- #}
                                <img src="{{ puppy.main_image_s3_key | s3_url or url_for('static', filename='img/placeholder.jpg') }}" class="puppy-thumbnail" alt="Photo of {{ puppy.name }}">
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
            {% endif %}

        </div>
        {% endfor %}
    {% else %}
    <div class="container my-5">
        <div class="alert alert-info text-center" role="alert">
            There are no parent dogs to display at this time.
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bs5-lightbox@1.8.3/dist/index.bundle.min.js"></script>
<script src="{{ url_for('static', filename='js/parents_carousel.js') }}"></script>
{% endblock %}