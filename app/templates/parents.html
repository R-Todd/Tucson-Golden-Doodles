{% extends "base.html" %}

{% block title %}Our Parents - Tucson Golden Doodles{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    {% if parents %}
        {% for parent in parents %}
        <div class="parent-name-banner" id="parent-{{ parent.id }}">
            <h1 class="display-5 text-white text-uppercase text-center py-3">{{ parent.name }}</h1>
        </div>

        <div class="container my-5">
            <div class="row g-4 parent-layout-container">
                <div class="col-md-6 parent-image-column">
                    {# --- MODIFIED: Collect S3 Keys instead of URLs --- #}
                    {% set all_carousel_keys = [] %}
                    {% if parent.main_image_s3_key %}{% set _ = all_carousel_keys.append(parent.main_image_s3_key) %}{% endif %}
                    {% if parent.alternate_image_s3_key_1 %}{% set _ = all_carousel_keys.append(parent.alternate_image_s3_key_1) %}{% endif %}
                    {% if parent.alternate_image_s3_key_2 %}{% set _ = all_carousel_keys.append(parent.alternate_image_s3_key_2) %}{% endif %}
                    {% if parent.alternate_image_s3_key_3 %}{% set _ = all_carousel_keys.append(parent.alternate_image_s3_key_3) %}{% endif %}
                    {% if parent.alternate_image_s3_key_4 %}{% set _ = all_carousel_keys.append(parent.alternate_image_s3_key_4) %}{% endif %}

                    {% if all_carousel_keys %}
                    <div id="parentCarousel-{{ parent.id }}" class="carousel slide parent-carousel-wrapper">
                        <div class="carousel-indicators">
                            {% for loop_index in range(all_carousel_keys|length) %}
                            <button type="button" data-bs-target="#parentCarousel-{{ parent.id }}" data-bs-slide-to="{{ loop_index }}" class="{{ 'active' if loop.first }}" aria-current="{{ 'true' if loop.first }}" aria-label="Slide {{ loop_index + 1 }}"></button>
                            {% endfor %}
                        </div>
                        <div class="carousel-inner">
                            {# --- MODIFIED: Loop through keys and apply the s3_url filter --- #}
                            {% for s3_key in all_carousel_keys %}
                            <div class="carousel-item {{ 'active' if loop.first }}">
                                {% if loop.first and parent.main_image_s3_key_small %}
                                    <img src="{{ parent.main_image_s3_key_large | s3_url }}"
                                         srcset="{{ parent.main_image_s3_key_small | s3_url }} 480w,
                                                 {{ parent.main_image_s3_key_medium | s3_url }} 800w,
                                                 {{ parent.main_image_s3_key_large | s3_url }} 1200w"
                                         sizes="(max-width: 767px) 90vw, 45vw"
                                         class="d-block w-100 carousel-image"
                                         alt="Photo of {{ parent.name }}"
                                         {% if not loop.first %}loading="lazy"{% endif %}>
                                {% else %}
                                    <img src="{{ s3_key | s3_url }}"
                                         class="d-block w-100 carousel-image"
                                         alt="Parent image {{ loop.index }}"
                                         {% if not loop.first %}loading="lazy"{% endif %}>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#parentCarousel-{{ parent.id }}" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#parentCarousel-{{ parent.id }}" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    </div>
                    {% else %}
                    <div class="main-image-wrapper p-2">
                        <img src="{{ url_for('static', filename='img/placeholder.jpg') }}" class="img-fluid parent-main-image" alt="No image available">
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-6 parent-info-column">
                    </div>
            </div>

            {# --- MODIFIED: Past puppies section also uses the s3_url filter --- #}
            {% if parent.grouped_litters %}
            <div class="past-puppies-header mt-5 text-center">
                <h2>{{ parent.name | upper }}'S PAST PUPPIES</h2>
            </div>
            {% for (birth_date, dad, mom), puppies in parent.grouped_litters.items() %}
                <div class="litter-banner">
                    <a href="{{ url_for('puppies.list_puppies') }}#litter-{{ birth_date.strftime('%Y%m%d') }}-{{ dad.id }}-{{ mom.id }}">
                        Litter with ...
                    </a>
                </div>
                <div class="past-puppies-thumbnails-row">
                    <div class="d-flex flex-nowrap overflow-auto py-2">
                        {% for puppy in puppies %}
                        <div class="p-2 flex-shrink-0 puppy-thumbnail-wrapper">
                            <a href="..." title="{{ puppy.name }} ({{ puppy.status.value }})">
                                <img src="{{ puppy.main_image_s3_key | s3_url }}" class="puppy-thumbnail" alt="Photo of {{ puppy.name }}">
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
            {% endif %}
        </div>
        {% endfor %}
    {% else %}
    <div class="container my-5">
        <div class="alert alert-info text-center" role="alert">
            There are no parent dogs to display at this time.
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bs5-lightbox@1.8.3/dist/index.bundle.min.js"></script>
<script src="{{ url_for('static', filename='js/parents_carousel.js') }}"></script>
{% endblock %}